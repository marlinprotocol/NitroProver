// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {NitroProver} from "../src/NitroProver.sol";

contract NitroProverScript is Script {
    NitroProver nitroProver;
    bytes attestation_doc;
    bytes pcrs;
    bytes[5] certs;

    function setUp() public {
        uint256 deployerPrivKey = vm.envUint("ARB_SEPOLIA_KEY");

        vm.broadcast(deployerPrivKey);
        nitroProver = new NitroProver();

        console.log(address(nitroProver));

        // curl -v 13.200.82.143:1300 -o attestation.bin
        attestation_doc = vm.readFileBinary("./script/attestation.bin");
        pcrs = abi.encodePacked(
            hex"00000017", // pcr index starting from LSB. This represents PCR0,PCR1,PCR2,PCR4
            hex"ea6ff0cc81650a6a2e5e6b009b058d684600ea08006beafb60a693e2eeb362e3a06039ff8341f0715543672c5c9ffa61", 
            hex"41245c1ef3514f08230e85fd21d97dee1eb2c3cfbca59cabd15b8858bc45c019acbbf1ec737cec472ffd0b0d8040e4ba", 
            hex"861ca1d00bed2c7d8fa0bf5aa11fcb6a002fe729f3123477d470299fc5eb72ae886d33c3d73216064f9dc15e3f7251e2",
            hex"4f646fa18676065e77ed5b03b51755e30cf9ce450c2f6ae58b0e31e6308d58f576ea295d8579c1bf27db1de8fda9dd9a"
        );
        certs[0] = hex"3082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff6";
        certs[1] = hex"308202be30820245a003020102021053a8e7aef8260e8d3733b92682d0a7e6300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234303430323035333631345a170d3234303432323036333631345a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e343330643638336437613533643965302e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004edc8d427e44e7322739f5dae412322f59a2449593ae63820e3c21efd005092aa2e8054f696e5a393648bd2977d0a4376bc91223e3def539ea3821a87a0ad7ee91177214dbfded91c9818a79604b3009c164d89b6b3b1bde29bcc3ab6795c9ad3a381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e041604146fb18d4966cef96d670d190c41bddae3670cd46f300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036700306402307e6ec4348a7abceb51b2a78389996df1a5568e5d89e1da5c38aeaa3bce88b4c4f98bc41853f7427288ed0009a69f1e960230379f14de7d89f192ec5278cfe1b21b73b1adc49025a7cbe32d72bf17aeb6f61f17ae6c7d08b55cadd66a08cc91291aac";
        certs[2] = hex"308203173082029ea0030201020210423034ee39147f2176962cbc5f070e39300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e343330643638336437613533643965302e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303430333132343231315a170d3234303430393032343231315a30818a313d303b06035504030c34313561666461653535393463616239352e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b8104002203620004534f3310bb39a2b5a5c8e9585c808f287832160d08933139a5f06fc0a1727249200fec8ea0a49f8247012670675c8147ddb566877b720cbfe0c1aca72edf08e1d53161798fa3dcdc7fd4ffb6bebd37e816ae89c748948cc3e5a2813fd3423bd7a381ec3081e930120603551d130101ff040830060101ff020101301f0603551d230418301680146fb18d4966cef96d670d190c41bddae3670cd46f301d0603551d0e041604143519e33e3a40595df496bc758c8d914263ac1663300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d312d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d312e616d617a6f6e6177732e636f6d2f63726c2f39623739633062662d663834302d343866352d383134352d3263303965373532343637652e63726c300a06082a8648ce3d04030303670030640230692f1f06d1769a1d4d7a70184a5c7f0b233768a9b13d6fb6728c13904362f54a7833fe2b1363d6dd71bdc808faf3ebf0023044d127456816e63652ad8e6ded2db804c9f4ba7902e59c976ef47ceac7c77842eda4d31a5cc346f7a64e893dd276da61";
        certs[3] = hex"3082028130820206a00302010202143a84626a62e1e7feba52a1d58dfe4b0a6e983b4b300a06082a8648ce3d04030330818a313d303b06035504030c34313561666461653535393463616239352e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234303430333233343831355a170d3234303430343233343831355a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30353862616334303065343236636332342e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b810400220362000403c739e545974ae8afcf520c013d9bbd1e5d376d00847bd127387ef8c5978a2e3965cf99f5a565f24572b0fc0d0ac4119f208530463439cc5d655b46eb002bea2648fa32e6ea5563b07e3f632172f3bcb4e451ba085e827b13cc326e78f3c455a326302430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204300a06082a8648ce3d0403030369003066023100d0ad67e1a6011ac0b1748ddf32de639327756091ea16a069930816d050e0d62b65f558fd3aabd1b103c6ac68c17d8cb2023100bc4ff6947524cad340c6a7bae76df504fbfab3b04e64fa6a3344bc9633264edf228eedaff90dbfead38ab26011ca7c1f";
        certs[4] = hex"3082027d30820203a0030201020210018e0924a1c4673e00000000660e6a89300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30353862616334303065343236636332342e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303430343038353332365a170d3234303430343131353332395a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30353862616334303065343236636332342d656e63303138653039323461316334363733652e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004154fada14315933b24bafcac67e6911b99755e4eec168162dfb2111c07672f8d86baa4d0743c697a8a4960be8e61e573cd38f86ab4411dbefd99e92bf226bacd7c99a35a6d987bc99460b702d98f2c8cf51a76702f5db5fa5fac51ae493513c7a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d040303036800306502303faeb3987c7d628202eca286040cd0cb7420a5509314dc7e51af22d383d02f4eb63d3b0aff5df383162baacda71d8ce3023100d103b0a82b7124f59a439097a6085b76b348dc6c92544e9f9a57e79e6ecfa82e603d13112c52cae7773ccdc29c8de9ae";
    }

    function run() public {
        uint256 deployerPrivKey = vm.envUint("ARB_SEPOLIA_KEY");
        vm.startBroadcast(deployerPrivKey);
        bytes32 parentCertHash = keccak256(certs[0]);
        for(uint256 i = 1; i < certs.length; i++) {
            nitroProver.verifyCert(certs[i], parentCertHash);
            parentCertHash = keccak256(certs[i]);
        }
        nitroProver.verifyAttestation(attestation_doc, pcrs, 365 days);
        vm.stopBroadcast();
    }
}
