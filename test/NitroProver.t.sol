// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.24;

import {Test, console} from "forge-std/Test.sol";
import { TestMock } from "../src/mock/TestMock.sol";

contract CounterTest is Test {
    TestMock nitroProverTest;
    bytes attestation_doc;

    function setUp() public {
        vm.warp(1708930774);
        nitroProverTest = new TestMock();
        attestation_doc = vm.readFileBinary("./test/nitro-attestation/sample_attestation.bin");
    }

    function test_nitro_attestation_verify() public {
        bytes memory pcrs = abi.encodePacked(
            hex"00000017", // pcr index starting from LSB. This represents PCR0,PCR1,PCR2,PCR4
            hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790", 
            hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16", 
            hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5",
            hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74"
        );
        nitroProverTest.t_verifyAttestation(attestation_doc, pcrs, 365 days);
    }

    function test_nitro_attestation_verify2() public {
        vm.warp(1712149757);
        bytes memory pcrs = abi.encodePacked(
            hex"00000017", // pcr index starting from LSB. This represents PCR0,PCR1,PCR2,PCR4
            hex"ea6ff0cc81650a6a2e5e6b009b058d684600ea08006beafb60a693e2eeb362e3a06039ff8341f0715543672c5c9ffa61", 
            hex"41245c1ef3514f08230e85fd21d97dee1eb2c3cfbca59cabd15b8858bc45c019acbbf1ec737cec472ffd0b0d8040e4ba", 
            hex"861ca1d00bed2c7d8fa0bf5aa11fcb6a002fe729f3123477d470299fc5eb72ae886d33c3d73216064f9dc15e3f7251e2",
            hex"4f646fa18676065e77ed5b03b51755e30cf9ce450c2f6ae58b0e31e6308d58f576ea295d8579c1bf27db1de8fda9dd9a"
        );
        bytes memory recent_attestation_doc = vm.readFileBinary("./test/nitro-attestation/sample_attestation2.bin");
        nitroProverTest.t_verifyAttestation(recent_attestation_doc, pcrs, 365 days);
        vm.warp(1708930774);
    }

    function test_processAttestationDoc() public {
        bytes memory pcrs = abi.encodePacked(
            hex"00000017", // pcr index starting from LSB. This represents PCR0,PCR1,PCR2,PCR4
            hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790", 
            hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16", 
            hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5",
            hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74"
        );
        bytes memory attestation_payload = hex"a9696d6f64756c655f69647827692d30646632333766303431386665623431652d656e633031386431633765663934656231313066646967657374665348413338346974696d657374616d701b0000018de43873df6470637273b000583017bf8f048519797be90497001a7559a3d555395937117d76f8baaedf56ca6d97952de79479bc0c76e5d176d20f6637900158305d3938eb05288e20a981038b1861062ff4174884968a39aee5982b312894e60561883576cc7381d1a7d05b809936bd16025830249037310daa90f4eb0703e7b105a241fdb09f12d3c40b7aea2f39e57b07b887e6ff4e4f9757943e127e391626b5e4d5035830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000045830bed9c17c27bdec410da8cabfa9aeb868e557679c88f49f90f5b538460c5538c2c674049f1122951f46554bdf2fb0ce740558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b63657274696669636174655902823082027e30820203a0030201020210018d1c7ef94eb1100000000065dc36d8300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232363036353933335a170d3234303232363039353933365a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30646632333766303431386665623431652d656e63303138643163376566393465623131302e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100fea3f5cfaf969d75e7b9583ce3313e994df0baee848f11f7be2fd1a7629f69b303ef73cd28cca11c207da137222a63c6023100d34de845696123850a2e379acc1968377e236d495c75ab10380fd93941cb4abf61bacb503027315471a58a12612943ff68636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820246a003020102021100c2214cef35dce956d271014dfb690a78300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234303232323039333631345a170d3234303331333130333631335a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004391150826e3d294294cc0e41dd5ef8838adbc7fda26bf30f1216b0ef8446cc15f4e3c854b51c6a1986cfa91765f247deb4b5bcd28f3cf494a457c1edda7e342ea5e70964f2e376b28277feb26451273be08f5754bc92671810a34ea436bb6c71a381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414c3da0dddfa2796d4a019b76a98ad11cca79b216e300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036700306402307042d879d5ae1bd58cafcd3770b76319db3fab757726777940b60d15e788731718fe37423b1a372675d8123278c337c0023047d66f188e8a4adcc7c758700fbe5ab6ce3cf651e4fb787ae58333591e574661156b04c18ae8c6e6e562eeb992acecd859031c308203183082029fa003020102021100bfd5eb6f8f94e91c5a78551db69099b4300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232353232323730305a170d3234303330323135323730305a30818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200042501155d788daf53fd05ff7e58747c5903f88c4aacb447117f95cf0128195b60927863b77faeabb4f707c35cfb0913742c0b8611ce4fc821980d066e3dd7079d4de970259f28881fe5e5431154f3699b70c7f05f4bdb6ddca7dc64b110db802aa381ec3081e930120603551d130101ff040830060101ff020101301f0603551d23041830168014c3da0dddfa2796d4a019b76a98ad11cca79b216e301d0603551d0e04160414bbfa7fafe786879d5c556e491ff69046d2f88c62300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d312d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d312e616d617a6f6e6177732e636f6d2f63726c2f31623135353833302d383237392d346438622d613532392d3938646331316365643763322e63726c300a06082a8648ce3d04030303670030640230244584566b8f15cd710ffca21b56681f3d0a55f7b67ca63f0d28850f2e46184d1d3df6c7d90529639b20a8e1581927c702304d035abd10aa140f348dcec14ebfed9b8e5747d9f17161088431b6dfcbad30436eabc20b184235a05bc0f87fe5e3ec7d5902863082028230820207a003020102021500a3a0212a22a5b3dc7aed5c5fb7b1a4a0e73ff6f9300a06082a8648ce3d04030330818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234303232363030353734355a170d3234303232373030353734355a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200046baba8f1e9aa967fe7e3fa54b89138cc89dda5be11a1b52df080d94178e30105e76f08b75aa6caebefe8963366bb6dd0a22b33c6dc689a99448a0a16d2a7225e7d48941ee8f8b2b0523f77127dbfacc2866008a8bb9082b20a0f71a1e4eb0edea326302430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204300a06082a8648ce3d04030303690030660231008c17793b08ef637fa59ad80c2db1461c9fc54044c992e31b7a9ce631adab97e7cd44e6a4a3e6e825738426195700df83023100f1498b85e90cfdc0bc88a08434ef46673d58d1df6633ee0b580895f0b2112185d8d468ffdf2927ea855be2383e52a9696a7075626c69635f6b65795820d239fd059dd0e0a01e280bec44903bb8143bae7e578b9844c6df5fd6351eddc069757365725f64617461582a7b22746f74616c5f6d656d6f7279223a323039313239383831362c22746f74616c5f63707573223a317d656e6f6e6365f6";
        nitroProverTest.t_processAttestationDoc(attestation_payload, pcrs, 365 days);
    }

    function test_processSignature() public {
        bytes memory sig = hex"14191157da6056c4f7f71e616fc3440626fe6d598ea57560036b5270b200c12e7c4a5b19b145a802c605dbc9f274c1f623d8f033ec17fd46b05e643039f3dde92f636df71e299ea6a50f0e87c812f61b2ae8ea99021a7d54058a577242a01641";
        bytes memory pubKey = hex"04eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6a";
        bytes memory payload = hex"846a5369676e61747572653144a101382240591116a9696d6f64756c655f69647827692d30646632333766303431386665623431652d656e633031386431633765663934656231313066646967657374665348413338346974696d657374616d701b0000018de43873df6470637273b000583017bf8f048519797be90497001a7559a3d555395937117d76f8baaedf56ca6d97952de79479bc0c76e5d176d20f6637900158305d3938eb05288e20a981038b1861062ff4174884968a39aee5982b312894e60561883576cc7381d1a7d05b809936bd16025830249037310daa90f4eb0703e7b105a241fdb09f12d3c40b7aea2f39e57b07b887e6ff4e4f9757943e127e391626b5e4d5035830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000045830bed9c17c27bdec410da8cabfa9aeb868e557679c88f49f90f5b538460c5538c2c674049f1122951f46554bdf2fb0ce740558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b63657274696669636174655902823082027e30820203a0030201020210018d1c7ef94eb1100000000065dc36d8300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232363036353933335a170d3234303232363039353933365a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30646632333766303431386665623431652d656e63303138643163376566393465623131302e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100fea3f5cfaf969d75e7b9583ce3313e994df0baee848f11f7be2fd1a7629f69b303ef73cd28cca11c207da137222a63c6023100d34de845696123850a2e379acc1968377e236d495c75ab10380fd93941cb4abf61bacb503027315471a58a12612943ff68636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820246a003020102021100c2214cef35dce956d271014dfb690a78300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234303232323039333631345a170d3234303331333130333631335a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004391150826e3d294294cc0e41dd5ef8838adbc7fda26bf30f1216b0ef8446cc15f4e3c854b51c6a1986cfa91765f247deb4b5bcd28f3cf494a457c1edda7e342ea5e70964f2e376b28277feb26451273be08f5754bc92671810a34ea436bb6c71a381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414c3da0dddfa2796d4a019b76a98ad11cca79b216e300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036700306402307042d879d5ae1bd58cafcd3770b76319db3fab757726777940b60d15e788731718fe37423b1a372675d8123278c337c0023047d66f188e8a4adcc7c758700fbe5ab6ce3cf651e4fb787ae58333591e574661156b04c18ae8c6e6e562eeb992acecd859031c308203183082029fa003020102021100bfd5eb6f8f94e91c5a78551db69099b4300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232353232323730305a170d3234303330323135323730305a30818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200042501155d788daf53fd05ff7e58747c5903f88c4aacb447117f95cf0128195b60927863b77faeabb4f707c35cfb0913742c0b8611ce4fc821980d066e3dd7079d4de970259f28881fe5e5431154f3699b70c7f05f4bdb6ddca7dc64b110db802aa381ec3081e930120603551d130101ff040830060101ff020101301f0603551d23041830168014c3da0dddfa2796d4a019b76a98ad11cca79b216e301d0603551d0e04160414bbfa7fafe786879d5c556e491ff69046d2f88c62300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d312d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d312e616d617a6f6e6177732e636f6d2f63726c2f31623135353833302d383237392d346438622d613532392d3938646331316365643763322e63726c300a06082a8648ce3d04030303670030640230244584566b8f15cd710ffca21b56681f3d0a55f7b67ca63f0d28850f2e46184d1d3df6c7d90529639b20a8e1581927c702304d035abd10aa140f348dcec14ebfed9b8e5747d9f17161088431b6dfcbad30436eabc20b184235a05bc0f87fe5e3ec7d5902863082028230820207a003020102021500a3a0212a22a5b3dc7aed5c5fb7b1a4a0e73ff6f9300a06082a8648ce3d04030330818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234303232363030353734355a170d3234303232373030353734355a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200046baba8f1e9aa967fe7e3fa54b89138cc89dda5be11a1b52df080d94178e30105e76f08b75aa6caebefe8963366bb6dd0a22b33c6dc689a99448a0a16d2a7225e7d48941ee8f8b2b0523f77127dbfacc2866008a8bb9082b20a0f71a1e4eb0edea326302430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204300a06082a8648ce3d04030303690030660231008c17793b08ef637fa59ad80c2db1461c9fc54044c992e31b7a9ce631adab97e7cd44e6a4a3e6e825738426195700df83023100f1498b85e90cfdc0bc88a08434ef46673d58d1df6633ee0b580895f0b2112185d8d468ffdf2927ea855be2383e52a9696a7075626c69635f6b65795820d239fd059dd0e0a01e280bec44903bb8143bae7e578b9844c6df5fd6351eddc069757365725f64617461582a7b22746f74616c5f6d656d6f7279223a323039313239383831362c22746f74616c5f63707573223a317d656e6f6e6365f6";
        nitroProverTest.t_processSignature(sig, pubKey, payload);
    }

    function test_validatePCRs() public {
        bytes memory expected_pcrs = abi.encodePacked(
            hex"00000017", // pcr index starting from LSB. This represents PCR0,PCR1,PCR2,PCR4
            hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790", 
            hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16", 
            hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5",
            hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74"
        );
        bytes[] memory pcrs = new bytes[](16);
        pcrs[0] = bytes(hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790");
        pcrs[1] = bytes(hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16");
        pcrs[2] = bytes(hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5");
        pcrs[3] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[4] = bytes(hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74");
        pcrs[5] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[6] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[7] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[8] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[9] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[10] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[11] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[12] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[13] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[14] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        pcrs[15] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        nitroProverTest.t_validatePCRs(pcrs, expected_pcrs);
    }

    function test_orderPCRs() public {
        bytes[] memory expected_ordered_pcrs = new bytes[](16);
        expected_ordered_pcrs[0] = bytes(hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790");
        expected_ordered_pcrs[1] = bytes(hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16");
        expected_ordered_pcrs[2] = bytes(hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5");
        expected_ordered_pcrs[3] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[4] = bytes(hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74");
        expected_ordered_pcrs[5] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[6] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[7] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[8] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[9] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[10] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[11] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[12] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[13] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[14] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
        expected_ordered_pcrs[15] = bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");

        bytes[2][] memory pcrs = new bytes[2][](16);
        pcrs[6] = [bytes(hex"00"), bytes(hex"17BF8F048519797BE90497001A7559A3D555395937117D76F8BAAEDF56CA6D97952DE79479BC0C76E5D176D20F663790")];
        pcrs[12] = [bytes(hex"01"), bytes(hex"5D3938EB05288E20A981038B1861062FF4174884968A39AEE5982B312894E60561883576CC7381D1A7D05B809936BD16")];
        pcrs[2] = [bytes(hex"02"), bytes(hex"249037310DAA90F4EB0703E7B105A241FDB09F12D3C40B7AEA2F39E57B07B887E6FF4E4F9757943E127E391626B5E4D5")];
        pcrs[3] = [bytes(hex"03"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[9] = [bytes(hex"04"), bytes(hex"BED9C17C27BDEC410DA8CABFA9AEB868E557679C88F49F90F5B538460C5538C2C674049F1122951F46554BDF2FB0CE74")];
        pcrs[5] = [bytes(hex"05"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[15] = [bytes(hex"06"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[7] = [bytes(hex"07"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[8] = [bytes(hex"08"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[14] = [bytes(hex"09"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[10] = [bytes(hex"0a"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[11] = [bytes(hex"0b"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[1] = [bytes(hex"0c"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[13] = [bytes(hex"0d"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[4] = [bytes(hex"0e"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];
        pcrs[0] = [bytes(hex"0f"), bytes(hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")];

        bytes[] memory actual_ordered_pcrs = nitroProverTest.t_orderPCRs(pcrs);
        require(keccak256(abi.encode(expected_ordered_pcrs)) == keccak256(abi.encode(actual_ordered_pcrs)));
        for(uint256 i = 0; i < expected_ordered_pcrs.length; i++) {
            require(keccak256(abi.encode(expected_ordered_pcrs[i])) == keccak256(abi.encode(actual_ordered_pcrs[i])), "ordering doesnt match");
        }
    }

    function test_verifyCerts() public {
        bytes memory certificate = hex"3082027e30820203a0030201020210018d1c7ef94eb1100000000065dc36d8300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232363036353933335a170d3234303232363039353933365a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30646632333766303431386665623431652d656e63303138643163376566393465623131302e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100fea3f5cfaf969d75e7b9583ce3313e994df0baee848f11f7be2fd1a7629f69b303ef73cd28cca11c207da137222a63c6023100d34de845696123850a2e379acc1968377e236d495c75ab10380fd93941cb4abf61bacb503027315471a58a12612943ff";
        bytes memory rawCAbundle = hex"845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820246a003020102021100c2214cef35dce956d271014dfb690a78300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234303232323039333631345a170d3234303331333130333631335a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004391150826e3d294294cc0e41dd5ef8838adbc7fda26bf30f1216b0ef8446cc15f4e3c854b51c6a1986cfa91765f247deb4b5bcd28f3cf494a457c1edda7e342ea5e70964f2e376b28277feb26451273be08f5754bc92671810a34ea436bb6c71a381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414c3da0dddfa2796d4a019b76a98ad11cca79b216e300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036700306402307042d879d5ae1bd58cafcd3770b76319db3fab757726777940b60d15e788731718fe37423b1a372675d8123278c337c0023047d66f188e8a4adcc7c758700fbe5ab6ce3cf651e4fb787ae58333591e574661156b04c18ae8c6e6e562eeb992acecd859031c308203183082029fa003020102021100bfd5eb6f8f94e91c5a78551db69099b4300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e363333303632303132303463646238352e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232353232323730305a170d3234303330323135323730305a30818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200042501155d788daf53fd05ff7e58747c5903f88c4aacb447117f95cf0128195b60927863b77faeabb4f707c35cfb0913742c0b8611ce4fc821980d066e3dd7079d4de970259f28881fe5e5431154f3699b70c7f05f4bdb6ddca7dc64b110db802aa381ec3081e930120603551d130101ff040830060101ff020101301f0603551d23041830168014c3da0dddfa2796d4a019b76a98ad11cca79b216e301d0603551d0e04160414bbfa7fafe786879d5c556e491ff69046d2f88c62300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d312d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d312e616d617a6f6e6177732e636f6d2f63726c2f31623135353833302d383237392d346438622d613532392d3938646331316365643763322e63726c300a06082a8648ce3d04030303670030640230244584566b8f15cd710ffca21b56681f3d0a55f7b67ca63f0d28850f2e46184d1d3df6c7d90529639b20a8e1581927c702304d035abd10aa140f348dcec14ebfed9b8e5747d9f17161088431b6dfcbad30436eabc20b184235a05bc0f87fe5e3ec7d5902863082028230820207a003020102021500a3a0212a22a5b3dc7aed5c5fb7b1a4a0e73ff6f9300a06082a8648ce3d04030330818a313d303b06035504030c34663039376133393666333031313337652e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234303232363030353734355a170d3234303232373030353734355a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200046baba8f1e9aa967fe7e3fa54b89138cc89dda5be11a1b52df080d94178e30105e76f08b75aa6caebefe8963366bb6dd0a22b33c6dc689a99448a0a16d2a7225e7d48941ee8f8b2b0523f77127dbfacc2866008a8bb9082b20a0f71a1e4eb0edea326302430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204300a06082a8648ce3d04030303690030660231008c17793b08ef637fa59ad80c2db1461c9fc54044c992e31b7a9ce631adab97e7cd44e6a4a3e6e825738426195700df83023100f1498b85e90cfdc0bc88a08434ef46673d58d1df6633ee0b580895f0b2112185d8d468ffdf2927ea855be2383e52a969";
        nitroProverTest.t_verifyCerts(certificate, rawCAbundle);
    }

    function test_verifyCert() public {
        bytes memory certificate = hex"3082027e30820203a0030201020210018d1c7ef94eb1100000000065dc36d8300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232363036353933335a170d3234303232363039353933365a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30646632333766303431386665623431652d656e63303138643163376566393465623131302e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100fea3f5cfaf969d75e7b9583ce3313e994df0baee848f11f7be2fd1a7629f69b303ef73cd28cca11c207da137222a63c6023100d34de845696123850a2e379acc1968377e236d495c75ab10380fd93941cb4abf61bacb503027315471a58a12612943ff";
        bytes memory pubKey = hex"046baba8f1e9aa967fe7e3fa54b89138cc89dda5be11a1b52df080d94178e30105e76f08b75aa6caebefe8963366bb6dd0a22b33c6dc689a99448a0a16d2a7225e7d48941ee8f8b2b0523f77127dbfacc2866008a8bb9082b20a0f71a1e4eb0ede";
        nitroProverTest.t_verifyCert(certificate, pubKey);
    }

    function test_parseTBS() public {
        bytes memory certificate = hex"3082027e30820203a0030201020210018d1c7ef94eb1100000000065dc36d8300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30646632333766303431386665623431652e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3234303232363036353933335a170d3234303232363039353933365a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30646632333766303431386665623431652d656e63303138643163376566393465623131302e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b8104002203620004eb09f84282efd096cbe7964dbe67070bae5e8086bc1188f3f7cf79a6095d85898f61660bc9a5c0ad9a56a6141420c6eef5d74446d7124d944676c1d9cf2b3cd46dec6f13056c634b01d1b9fe309c222f34a56247ceb037a56b7adcd428f0df6aa31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100fea3f5cfaf969d75e7b9583ce3313e994df0baee848f11f7be2fd1a7629f69b303ef73cd28cca11c207da137222a63c6023100d34de845696123850a2e379acc1968377e236d495c75ab10380fd93941cb4abf61bacb503027315471a58a12612943ff";
        uint256 ptr = 762903854686731323302323492349306293177430185082884;
        nitroProverTest.t_parseTbs(certificate, ptr);
    }
}
